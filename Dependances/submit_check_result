#!/bin/sh

su - nagios

urlencode() {
    local l=${#1}
    for (( i = 0 ; i < l ; i++ )); do
        local c=${1:i:1}
        case "$c" in
            [a-zA-Z0-9.~_-]) printf "$c" ;;
            ' ') printf + ;;
            *) printf '%%%.2X' "'$c"
        esac
    done
}

urldecode() {
    local data=${1//+/ }
    printf '%b' "${data//%/\x}"
}

echocmd="/bin/echo"

CommandFile="/srv/eyesofnetwork/nagios/var/log/rw/nagios.cmd"

# get the current date/time in seconds since UNIX epoch
datetime=`date +%s`

# create the command line to add to the command file
output=`urldecode $4`
cmdline="[$datetime] PROCESS_SERVICE_CHECK_RESULT;$1;$2;$3;`echo $output | tr '!' '"'`"

# append the command to the end of the command file
`$echocmd $cmdline >> $CommandFile`
